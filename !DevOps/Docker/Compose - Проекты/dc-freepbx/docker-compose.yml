version: '3.9'

services:
  freepbx-app:
    container_name: freepbx-app
    image: tiredofit/freepbx:15
    ports:
     #### If you aren't using a reverse proxy
     - 2000:80
     #### If you want SSL Support and not using a reverse proxy
     #- 443:443
     - 5060:5060/udp
     - 5160:5160/udp
     - 18000-18100:18000-18100/udp
     #### Flash Operator Panel
     - 4445:4445
    volumes:
     - ./freepbx/certs:/certs:rw
     - ./freepbx/data:/data:rw
     - ./freepbx/logs:/var/log:rw
     - ./freepbx/data/www:/var/www/html:rw
    privileged: true
    restart: always
    environment:
     #- DEBUG_MODE=TRUE
     # - VIRTUAL_HOST=10.104.2.100
     # - VIRTUAL_NETWORK=nginx-proxy
     # - VIRTUAL_NETWORK=host
     ### If you want to connect to the SSL Enabled Container 
     # - VIRTUAL_PORT=443
     # - VIRTUAL_PROTO=https
     # - VIRTUAL_PORT=80
     # - LETSENCRYPT_HOST=hostname.example.com
     # - LETSENCRYPT_EMAIL=email@example.com
     # - ZABBIX_HOSTNAME=freepbx-app
     - RTP_START=18000
     - RTP_FINISH=18100
     ## Use for External MySQL Server
     - DB_EMBEDDED=FALSE
     ### These are only necessary if DB_EMBEDDED=FALSE
     - DB_HOST=freepbx-db
     - DB_PORT=3306
     - DB_NAME=asterisk
     - DB_USER=asterisk
     - DB_PASS=asterisk_pwd
     # - ENABLE_FAIL2BAN=FALSE
     # - ENABLE_CRON=FALSE
     ### If you are using TLS Support for Apache to listen on 443 in the container drop them in /certs and set these:
     #- TLS_CERT=cert.pem
     #- TLS_KEY=key.pem 
    networks:
      - proxy-tier
    ### These final lines are for Fail2ban. If you don't want, comment and also add ENABLE_FAIL2BAN=FALSE to your environment
    cap_add:
      - NET_ADMIN

  freepbx-db:
    container_name: freepbx-db
    image: tiredofit/mariadb:10.11
    restart: always
    volumes:
      - ./db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_DATABASE=asterisk
      - MYSQL_USER=asterisk
      - MYSQL_PASSWORD=asterisk_pwd
    networks:
      - proxy-tier

  # freepbx-db-backup:
  #   container_name: freepbx-db-backup
  #   image: tiredofit/db-backup:3.7.5
  #   links:
  #    - freepbx-db
  #   volumes:
  #     - ./db-backup/dbbackup:/backup
  #   environment:
  #     - ZABBIX_HOSTNAME=freepbx-db-backup
  #     - DB_HOST=freepbx-db
  #     - DB_TYPE=mariadb
  #     - DB_NAME=asterisk
  #     - DB_USER=asterisk
  #     - DB_PASS=asterisk_pwd
  #     - DB_DUMP_FREQ=1440
  #     - DB_DUMP_BEGIN=0000
  #     - DB_CLEANUP_TIME=8640
  #     - COMPRESSION=BZ
  #     - MD5=TRUE
  #   networks:
  #     - proxy-tier
  #   restart: always

networks:
  proxy-tier:
    driver: bridge

# https://github.com/tiredofit/docker-freepbx

# That seems to have resolved it! rm -f cron.error, then fwconsole chown, then fwconsole reload outputs like normal. I ran fwconsole reload to make sure
# fix - chmod u+s /bin/busybox